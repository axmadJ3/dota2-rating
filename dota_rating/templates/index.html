{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Turbo Rating</title>
  <link rel="stylesheet" href= {% static "style.css" %}/>
</head>

<body>
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
  <header>
    <div class="header-left">
      <h1>Turbo Rating</h1>
    </div>
    <div class="header-right">
      <button id="refresh-rating">Refresh rating</button>
      {% if request.user.is_authenticated %}
        <a href="{% url "auth:logout" %}">
          <button id="signout-steam">Sign Out</button>
        </a>
      {% else %}
      <a href="{% url "social:begin" "steam" %}">
        <button id="auth-steam">Auth via Steam</button>
      </a>
      {% endif %}
      <div class="user-info">
        {% if request.user.is_authenticated %}
          <span id="user-nickname">{{ request.user.personaname }}</span> |
          <span id="user-rating">{{ user_total_rating }}</span>
        {% else %}
          <span id="user-nickname">Guest</span> |
          <span id="user-rating">1</span>
        {% endif %}
      </div>
    </div>
  </header>

  <nav>
    <button class="active" data-tab="rating">Table Rating</button>
    <button data-tab="stats">Your Stat</button>
  </nav>

  <!-- Table Rating Tab -->
  <div class="tab-content" id="rating-tab">
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>Nickname</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è -->
      </tbody>
    </table>
  </div>


  <!-- Your Stat Tab -->
  <div class="tab-content" id="stats-tab" style="display:none;">
    <table id="stats-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Hero</th>
          <th>Result</th>
          <th>K</th>
          <th>D</th>
          <th>A</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody>
        <!-- –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–µ–π -->
      </tbody>
    </table>
    <div id="loading" class="more-row">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>


  <script>
    const tabs = document.querySelectorAll('nav button');
    const ratingTab = document.getElementById('rating-tab');
    const statsTab = document.getElementById('stats-tab');
    const refreshBtn = document.getElementById('refresh-rating');

    const leaderboardBody = document.getElementById('leaderboard-body');
    const statsBody = document.querySelector('#stats-table tbody');
    const loadingIndicator = document.getElementById('loading');

    const userRatingSpan = document.getElementById('user-rating');
    const userRatingSpan2 = document.getElementById('user-rating-2');

    let offset = 0;
    let limit = 20;
    let loading = false;

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ratingTab.style.display = btn.dataset.tab === 'rating' ? 'block' : 'none';
        statsTab.style.display = btn.dataset.tab === 'stats' ? 'block' : 'none';
        if (btn.dataset.tab === 'stats' && statsBody.childElementCount === 0) {
          loadStats();
        }
      });
    });

    async function loadStats() {
      if (loading) return;
      loading = true;
      loadingIndicator.style.display = 'block';
      try {
        const resp = await fetch(`/api/user/stats?steam_id=${CURRENT_USER_STEAM_ID}&offset=${offset}&limit=${limit}`);
        const games = await resp.json();
        games.forEach(game => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(game.time).toLocaleString()}</td>
            <td>${game.hero}</td>
            <td>${game.result}</td>
            <td>${game.kills}</td>
            <td>${game.deaths}</td>
            <td>${game.assists}</td>
            <td>${game.rating}</td>
          `;
          statsBody.appendChild(row);
        });
        offset += games.length;
        if (games.length < limit) {
          loadingIndicator.textContent = '–ë–æ–ª—å—à–µ –Ω–µ—Ç –∏–≥—Ä';
          statsTab.removeEventListener('scroll', handleScroll);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π', e);
      } finally {
        loading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    function handleScroll() {
      const { scrollTop, scrollHeight, clientHeight } = statsTab;
      if (scrollTop + clientHeight >= scrollHeight - 50) {
        loadStats();
      }
    }
    statsTab.addEventListener('scroll', handleScroll);

    refreshBtn?.addEventListener('click', async () => {
      offset = 0;
      statsBody.innerHTML = '';
      statsTab.addEventListener('scroll', handleScroll);
      loadingIndicator.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        const csrftoken = document.getElementById('csrf-token').value;
        await fetch('/api/player/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken  // üîê –≤–∞–∂–Ω–æ
          },
          body: JSON.stringify({ steam_id: CURRENT_USER_STEAM_ID })
        });
        const resp = await fetch(`/api/player-position?steam_id=${CURRENT_USER_STEAM_ID}`);
        const data = await resp.json();
        userRatingSpan.textContent = data.rating;
        userRatingSpan2.textContent = data.rating;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞', e);
      }
      await loadStats();
    });

    async function loadLeaderboard() {
      const resp = await fetch('/api/leaderboard');
      const players = await resp.json();
      leaderboardBody.innerHTML = '';
      players.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i + 1}</td><td>${p.personaname}</td><td>${p.rating}</td>`;
        leaderboardBody.appendChild(tr);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadLeaderboard();
  </script>

  <script>
    const CURRENT_USER_STEAM_ID = "{{ request.user.steamid }}";
  </script>
</body>
</html>
