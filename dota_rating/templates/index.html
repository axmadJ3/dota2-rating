{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Turbo Rating</title>
  <link rel="stylesheet" href="{% static 'style.css' %}"/>
</head>

<body>
  <div id="notification" style="display: none;"></div>
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
  <header>
    <div class="header-left">
      <h1 style="display: flex; align-items: center;">
        <img src="{% static 'logo.png' %}" alt="Logo" style="height: 120px; margin-right: 10px;">
        <span style="line-height: 1;">Turbo Rating</span>
      </h1>
    </div>
    <div class="header-right">
      {% if request.user.is_authenticated %}
        <button id="refresh-rating">Refresh rating</button>
        <a href="{% url "auth:logout" %}">
          <button id="signout-steam">Sign Out</button>
        </a>
      {% else %}
        <a href="{% url "social:begin" "steam" %}">
          <button id="auth-steam">Auth via Steam</button>
        </a>
      {% endif %}
      <div class="user-info">
        {% if request.user.is_authenticated %}
        <div class="user-details">
          <span id="user-nickname">{{ request.user.personaname }}</span>
          <span class="separator">|</span>
          <span id="user-rating">{{ user_total_rating }}</span>
        </div>
        {% else %}
          <span id="user-nickname">Guest</span>
        {% endif %}
        <img src="{% static 'logo.png' %}" alt="Logo" class="header-logo">
      </div>
    </div>
  </header>

  <nav>
    <button class="active" data-tab="rating">Top Rating</button>
    <button data-tab="stats">Your History</button>
  </nav>

  <div class="tab-content" id="rating-tab">
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>Nickname</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>

    <div style="text-align: center; margin: 20px 0;">
      <button id="load-more-leaderboard">Load More</button>
    </div>
  </div>

  <div class="tab-content" id="stats-tab" style="display:none;">
    {% if request.user.is_authenticated %}
      <table id="stats-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Duration</th>
            <th>Hero</th>
            <th>Result</th>
            <th>K</th>
            <th>D</th>
            <th>A</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="loading" class="more-row">Loading...</div>
    {% else %}
      <div style="text-align: center; margin-top: 40px;">
        <h2>Please sign in via Steam to view your match history</h2>
      </div>
    {% endif %}
  </div>

<script>
  const tabs = document.querySelectorAll('nav button');
  const ratingTab = document.getElementById('rating-tab');
  const statsTab = document.getElementById('stats-tab');
  const refreshBtn = document.getElementById('refresh-rating');
  const leaderboardBody = document.getElementById('leaderboard-body');
  const statsBody = document.querySelector('#stats-table tbody');
  const loadingIndicator = document.getElementById('loading');

  let offset = 0;
  let limit = 20;
  let loading = false;

  // üîÑ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ù–ê–ß–ò–ù–ê–Æ–¢–°–Ø –ó–î–ï–°–¨
  let CURRENT_USER_ROW_ID = 'user-position-row';
  let CURRENT_USER_STEAM_ID = null;
  {% if request.user.is_authenticated %}
    CURRENT_USER_STEAM_ID = "{{ request.user.steamid }}";
  {% endif %}

  function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.opacity = '1';
    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 300);
    }, duration);
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ratingTab.style.display = btn.dataset.tab === 'rating' ? 'block' : 'none';
      if (statsTab) statsTab.style.display = btn.dataset.tab === 'stats' ? 'block' : 'none';
      if (btn.dataset.tab === 'stats' && statsBody && statsBody.childElementCount === 0) {
        loadStats();
      }
    });
  });

  function formatDuration(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}:${sec.toString().padStart(2, '0')}`;
  }

  async function loadStats() {
    if (loading) return;
    loading = true;
    loadingIndicator.style.display = 'block';
    try {
      const resp = await fetch(`/api/user/stats?steam_id=${CURRENT_USER_STEAM_ID}&offset=${offset}&limit=${limit}`);
      const games = await resp.json();
      games.forEach(game => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(game.time).toLocaleString()}</td>
          <td>${formatDuration(game.duration)}</td>
          <td>${game.hero}</td>
          <td>${game.result}</td>
          <td>${game.kills}</td>
          <td>${game.deaths}</td>
          <td>${game.assists}</td>
          <td>${game.rating}</td>
        `;
        statsBody.appendChild(row);
      });
      offset += games.length;
      if (games.length < limit) {
        loadingIndicator.textContent = '–ë–æ–ª—å—à–µ –Ω–µ—Ç –∏–≥—Ä';
        statsTab.removeEventListener('scroll', handleScroll);
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π', e);
    } finally {
      loading = false;
      loadingIndicator.style.display = 'none';
    }
  }

  function handleScroll() {
    const { scrollTop, scrollHeight, clientHeight } = statsTab;
    if (scrollTop + clientHeight >= scrollHeight - 50) {
      loadStats();
    }
  }

  if (statsTab) statsTab.addEventListener('scroll', handleScroll);

  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      offset = 0;
      statsBody.innerHTML = '';
      statsTab.addEventListener('scroll', handleScroll);
      loadingIndicator.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        const csrftoken = document.getElementById('csrf-token').value;
        await fetch('/api/player/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ steam_id: CURRENT_USER_STEAM_ID })
        });

        const resp = await fetch(`/api/player-position?steam_id=${CURRENT_USER_STEAM_ID}`);
        const data = await resp.json();
        document.getElementById('user-rating').textContent = data.rating;

        await loadLeaderboard();
      } catch (e) {
        console.error('Rating update error', e);
      }

      await loadStats();
      showNotification('Rating and statistics updated');
    });
  }

  let leaderboardOffset = 0;
  let leaderboardLimit = 50;
  let leaderboardFinished = false;

  async function loadLeaderboard() {
    if (leaderboardFinished) return;

    const resp = await fetch(`/api/leaderboard?offset=${leaderboardOffset}&limit=${leaderboardLimit}`);
    const players = await resp.json();

    if (players.length === 0) {
      leaderboardFinished = true;
      document.getElementById('load-more-leaderboard').style.display = 'none';
      return;
    }

    let currentUserInBatch = false;

    players.forEach((p, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${leaderboardOffset + i + 1}</td><td>${p.personaname}</td><td>${p.rating}</td>`;
      if (CURRENT_USER_STEAM_ID && p.steamid === CURRENT_USER_STEAM_ID) {
        tr.classList.add('highlight');
        currentUserInBatch = true;
      }
      leaderboardBody.appendChild(tr);
    });

    leaderboardOffset += players.length;

    // –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    const existingUserRow = document.getElementById(CURRENT_USER_ROW_ID);
    if (existingUserRow) existingUserRow.remove();
    const existingSeparator = document.getElementById(`${CURRENT_USER_ROW_ID}-separator`);
    if (existingSeparator) existingSeparator.remove();

    // ‚õî –î–æ–±–∞–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    if (CURRENT_USER_STEAM_ID && !currentUserInBatch) {
      try {
        const resp = await fetch(`/api/player-position?steam_id=${CURRENT_USER_STEAM_ID}`);
        const data = await resp.json();

        const separator = document.createElement('tr');
        separator.id = `${CURRENT_USER_ROW_ID}-separator`;
        separator.innerHTML = `<td colspan="3" style="text-align:center; color:#777;">...</td>`;
        leaderboardBody.appendChild(separator);

        const userRow = document.createElement('tr');
        userRow.id = CURRENT_USER_ROW_ID;
        userRow.innerHTML = `<td>${data.position}</td><td>${data.nickname}</td><td>${data.rating}</td>`;
        userRow.classList.add('highlight');
        leaderboardBody.appendChild(userRow);
      } catch (e) {
        console.error("Error getting the player's position", e);
      }
    }
  }

  loadLeaderboard();
  loadStats();

  document.getElementById('load-more-leaderboard').addEventListener('click', loadLeaderboard);
</script>

</body>
</html>
